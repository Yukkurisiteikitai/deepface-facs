<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¦–ç·šãƒã‚¦ã‚¹ã‚«ãƒ¼ã‚½ãƒ« & ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</title>
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #1a1a2e;
            --text-primary: #ffffff;
            --text-secondary: #888;
            --accent: #00ff88;
            --accent-2: #ff6b6b;
            --accent-3: #4ecdc4;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: var(--bg-dark);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        
        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            gap: 20px;
            padding: 15px 30px;
            background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, transparent 100%);
            z-index: 1000;
        }
        
        .nav a {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .nav a:hover {
            color: var(--text-primary);
            background: rgba(255,255,255,0.1);
        }
        
        .nav a.active {
            color: var(--accent);
            background: rgba(0, 255, 136, 0.1);
        }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
        .container {
            display: flex;
            height: 100vh;
            padding-top: 60px;
        }
        
        /* ãƒ“ãƒ‡ã‚ªã‚¨ãƒªã‚¢ */
        .video-area {
            width: 300px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .video-container {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: var(--bg-card);
        }
        
        #video {
            width: 100%;
            transform: scaleX(-1);
            display: block;
        }
        
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
            pointer-events: none;
        }
        
        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
        .control-panel {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
        }
        
        .control-panel h3 {
            color: var(--accent);
            margin-bottom: 15px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: var(--accent);
            color: #000;
        }
        
        .btn-primary:hover {
            background: #00cc6a;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
        }
        
        .btn-secondary:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .btn-danger {
            background: var(--accent-2);
            color: #fff;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #666;
        }
        
        .status-dot.active {
            background: var(--accent);
            box-shadow: 0 0 10px var(--accent);
        }
        
        .status-dot.calibrating {
            background: #ffaa00;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ */
        .slider-group {
            margin-bottom: 15px;
        }
        
        .slider-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 12px;
        }
        
        .slider-group input[type="range"] {
            width: 100%;
            accent-color: var(--accent);
        }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ï¼ˆè¦–ç·šè¿½è·¡ã‚¨ãƒªã‚¢ï¼‰ */
        .main-area {
            flex: 1;
            position: relative;
        }
        
        /* è¦–ç·šã‚«ãƒ¼ã‚½ãƒ« */
        #gaze-cursor {
            position: fixed;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid var(--accent);
            background: rgba(0, 255, 136, 0.2);
            pointer-events: none;
            transform: translate(-50%, -50%);
            z-index: 9999;
            display: none;
            transition: width 0.1s, height 0.1s, opacity 0.1s;
        }
        
        #gaze-cursor.low-confidence {
            border-color: rgba(0, 255, 136, 0.3);
            background: rgba(0, 255, 136, 0.05);
        }
        
        #gaze-cursor::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        
        /* ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #heatmap-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            opacity: 0.7;
            display: none;
        }
        
        /* ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #calibration-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        #calibration-overlay.active {
            display: flex;
        }
        
        .calibration-point {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--accent);
            display: none;
            cursor: pointer;
            animation: calibPulse 1s infinite;
        }
        
        .calibration-point.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .calibration-point::after {
            content: '';
            width: 8px;
            height: 8px;
            background: #000;
            border-radius: 50%;
        }
        
        @keyframes calibPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 20px var(--accent); }
            50% { transform: scale(1.2); box-shadow: 0 0 40px var(--accent); }
        }
        
        .calibration-message {
            color: var(--text-primary);
            font-size: 24px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .calibration-progress {
            display: flex;
            gap: 8px;
            margin-top: 20px;
        }
        
        .calibration-progress .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
        }
        
        .calibration-progress .dot.complete {
            background: var(--accent);
        }
        
        /* çµ±è¨ˆãƒ‘ãƒãƒ« */
        .stats-panel {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 12px;
        }
        
        .stat-value {
            color: var(--accent);
            font-weight: bold;
        }
        
        /* ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒœã‚¿ãƒ³ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰ */
        .demo-targets {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 50px;
            z-index: 50;
        }
        
        .demo-target {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            background: var(--bg-card);
            border: 2px solid rgba(255,255,255,0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .demo-target:hover {
            border-color: var(--accent);
            transform: scale(1.1);
        }
        
        .demo-target.gazed {
            background: rgba(0, 255, 136, 0.3);
            border-color: var(--accent);
        }
        
        /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent);
        }
        
        .checkbox-group label {
            color: var(--text-secondary);
            font-size: 13px;
        }
    </style>
</head>
<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <nav class="nav">
        <a href="index.html">ğŸ  ãƒ›ãƒ¼ãƒ </a>
        <a href="eye-focus.html">ğŸ‘ï¸ ç›®ã®åˆ†æ</a>
        <a href="advanced-eye.html">ğŸ”¬ é«˜åº¦ãªç›®åˆ†æ</a>
        <a href="screen-gaze.html" class="active">ğŸ¯ è¦–ç·šã‚«ãƒ¼ã‚½ãƒ«</a>
    </nav>
    
    <!-- è¦–ç·šã‚«ãƒ¼ã‚½ãƒ« -->
    <div id="gaze-cursor"></div>
    
    <!-- ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <canvas id="heatmap-overlay"></canvas>
    
    <!-- ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="calibration-overlay">
        <div class="calibration-message" id="calibration-message">
            ç·‘ã®ç‚¹ã‚’è¦‹ã¤ã‚ã¦ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„
        </div>
        <div class="calibration-point" id="calibration-point"></div>
        <div class="calibration-progress" id="calibration-progress"></div>
    </div>
    
    <div class="container">
        <!-- å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <div class="video-area">
            <div class="video-container">
                <video id="video" autoplay playsinline></video>
                <canvas id="overlay"></canvas>
            </div>
            
            <div class="control-panel">
                <h3>ğŸ® ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h3>
                
                <div class="status-indicator">
                    <div class="status-dot" id="status-dot"></div>
                    <span id="status-text">åˆæœŸåŒ–ä¸­...</span>
                </div>
                
                <button class="btn btn-primary" id="btn-calibrate">
                    ğŸ¯ ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
                </button>
                
                <button class="btn btn-secondary" id="btn-toggle-cursor" disabled>
                    ğŸ‘† ã‚«ãƒ¼ã‚½ãƒ«è¡¨ç¤º
                </button>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="chk-heatmap">
                    <label for="chk-heatmap">ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—è¡¨ç¤º</label>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="chk-decay">
                    <label for="chk-decay">ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—æ¸›è¡°</label>
                </div>
                
                <button class="btn btn-danger" id="btn-clear-heatmap">
                    ğŸ—‘ï¸ ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚¯ãƒªã‚¢
                </button>
                
                <button class="btn btn-secondary" id="btn-export">
                    ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                </button>
            </div>
            
            <div class="control-panel">
                <h3>âš™ï¸ è¨­å®š</h3>
                
                <div class="slider-group">
                    <label>ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°å¼·åº¦: <span id="smoothing-value">0.7</span></label>
                    <input type="range" id="slider-smoothing" min="0" max="1" step="0.1" value="0.7">
                </div>
                
                <div class="slider-group">
                    <label>ã‚«ãƒ¼ã‚½ãƒ«ã‚µã‚¤ã‚º: <span id="cursor-size-value">40</span>px</label>
                    <input type="range" id="slider-cursor-size" min="20" max="100" step="5" value="40">
                </div>
                
                <div class="slider-group">
                    <label>ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—åŠå¾„: <span id="heatmap-radius-value">50</span>px</label>
                    <input type="range" id="slider-heatmap-radius" min="20" max="150" step="10" value="50">
                </div>
            </div>
            
            <div class="stats-panel">
                <h3>ğŸ“Š çµ±è¨ˆ</h3>
                
                <div class="stat-item">
                    <span class="stat-label">è¦–ç·šãƒã‚¤ãƒ³ãƒˆæ•°</span>
                    <span class="stat-value" id="stat-points">0</span>
                </div>
                
                <div class="stat-item">
                    <span class="stat-label">ç”»é¢ã‚«ãƒãƒ¼ç‡</span>
                    <span class="stat-value" id="stat-coverage">0%</span>
                </div>
                
                <div class="stat-item">
                    <span class="stat-label">ä¿¡é ¼åº¦</span>
                    <span class="stat-value" id="stat-confidence">-</span>
                </div>
                
                <div class="stat-item">
                    <span class="stat-label">å¹³å‡ä½ç½®X</span>
                    <span class="stat-value" id="stat-avg-x">-</span>
                </div>
                
                <div class="stat-item">
                    <span class="stat-label">å¹³å‡ä½ç½®Y</span>
                    <span class="stat-value" id="stat-avg-y">-</span>
                </div>
            </div>
        </div>
        
        <!-- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ -->
        <div class="main-area">
            <div class="demo-targets" id="demo-targets">
                <div class="demo-target" data-id="1">ğŸ</div>
                <div class="demo-target" data-id="2">ğŸŠ</div>
                <div class="demo-target" data-id="3">ğŸ‹</div>
                <div class="demo-target" data-id="4">ğŸ‡</div>
                <div class="demo-target" data-id="5">ğŸ“</div>
                <div class="demo-target" data-id="6">ğŸ‘</div>
                <div class="demo-target" data-id="7">ğŸ¥</div>
                <div class="demo-target" data-id="8">ğŸ’</div>
                <div class="demo-target" data-id="9">ğŸ¥­</div>
            </div>
        </div>
    </div>
    
    <!-- ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« -->
    <script src="js/screen-gaze.js"></script>
    <script src="js/gaze-heatmap.js"></script>
    
    <script>
        // MediaPipe classes (å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§å–å¾—)
        let FaceLandmarker, FilesetResolver;
        
        // è¦ç´ å–å¾—
        const video = document.getElementById('video');
        const overlay = document.getElementById('overlay');
        const gazeCursor = document.getElementById('gaze-cursor');
        const heatmapCanvas = document.getElementById('heatmap-overlay');
        const calibrationOverlay = document.getElementById('calibration-overlay');
        const calibrationPoint = document.getElementById('calibration-point');
        const calibrationMessage = document.getElementById('calibration-message');
        const calibrationProgress = document.getElementById('calibration-progress');
        
        // çŠ¶æ…‹
        let faceLandmarker = null;
        let screenGazeTracker = null;
        let gazeHeatmap = null;
        let isRunning = false;
        let showCursor = false;
        let showHeatmap = false;
        let enableDecay = false;
        
        // ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
        let calibrationPoints = [];
        let currentCalibPoint = 0;
        let collectingSamples = false;
        let calibrationSamples = [];
        
        // UIã‚’æ›´æ–°
        function updateStatus(text, state = 'inactive') {
            document.getElementById('status-text').textContent = text;
            const dot = document.getElementById('status-dot');
            dot.classList.remove('active', 'calibrating');
            if (state === 'active') dot.classList.add('active');
            if (state === 'calibrating') dot.classList.add('calibrating');
        }
        
        // åˆæœŸåŒ–
        async function init() {
            updateStatus('ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...', 'calibrating');
            
            try {
                // ã‚«ãƒ¡ãƒ©èµ·å‹•
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 }
                });
                video.srcObject = stream;
                
                await new Promise(resolve => video.onloadedmetadata = resolve);
                
                overlay.width = video.videoWidth;
                overlay.height = video.videoHeight;
                
                // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚­ãƒ£ãƒ³ãƒã‚¹è¨­å®š
                heatmapCanvas.width = window.innerWidth;
                heatmapCanvas.height = window.innerHeight;
                
                // MediaPipeåˆæœŸåŒ–ï¼ˆå‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼‰
                updateStatus('MediaPipeèª­ã¿è¾¼ã¿ä¸­...', 'calibrating');
                
                const vision = await import('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest');
                FaceLandmarker = vision.FaceLandmarker;
                FilesetResolver = vision.FilesetResolver;
                
                const filesetResolver = await FilesetResolver.forVisionTasks(
                    'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm'
                );
                
                faceLandmarker = await FaceLandmarker.createFromOptions(filesetResolver, {
                    baseOptions: {
                        modelAssetPath: 'https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task',
                        delegate: 'GPU'
                    },
                    runningMode: 'VIDEO',
                    numFaces: 1,
                    outputFaceBlendshapes: false,
                    outputFacialTransformationMatrixes: false
                });
                
                // ãƒˆãƒ©ãƒƒã‚«ãƒ¼åˆæœŸåŒ–
                screenGazeTracker = new ScreenGazeTracker({
                    screenWidth: window.innerWidth,
                    screenHeight: window.innerHeight,
                    smoothingFactor: 0.7
                });
                
                // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—åˆæœŸåŒ–
                gazeHeatmap = new GazeHeatmap({
                    width: window.innerWidth,
                    height: window.innerHeight,
                    radius: 50
                });
                gazeHeatmap.setOutputCanvas(heatmapCanvas);
                
                // ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚¤ãƒ³ãƒˆã‚’ç”Ÿæˆ
                generateCalibrationPoints();
                
                updateStatus('æº–å‚™å®Œäº†', 'active');
                document.getElementById('btn-calibrate').disabled = false;
                
                // ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—é–‹å§‹
                isRunning = true;
                processFrame();
                
            } catch (error) {
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                updateStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'inactive');
            }
        }
        
        // ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚¤ãƒ³ãƒˆã‚’ç”Ÿæˆ
        function generateCalibrationPoints() {
            const padding = 100;
            const w = window.innerWidth;
            const h = window.innerHeight;
            
            calibrationPoints = [
                { x: padding, y: padding },                    // å·¦ä¸Š
                { x: w / 2, y: padding },                      // ä¸Šä¸­å¤®
                { x: w - padding, y: padding },                // å³ä¸Š
                { x: padding, y: h / 2 },                      // å·¦ä¸­å¤®
                { x: w / 2, y: h / 2 },                        // ä¸­å¤®
                { x: w - padding, y: h / 2 },                  // å³ä¸­å¤®
                { x: padding, y: h - padding },                // å·¦ä¸‹
                { x: w / 2, y: h - padding },                  // ä¸‹ä¸­å¤®
                { x: w - padding, y: h - padding }             // å³ä¸‹
            ];
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒ‰ãƒƒãƒˆç”Ÿæˆ
            calibrationProgress.innerHTML = calibrationPoints.map((_, i) => 
                `<div class="dot" data-index="${i}"></div>`
            ).join('');
        }
        
        // ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        function startCalibration() {
            screenGazeTracker.startCalibration();
            currentCalibPoint = 0;
            calibrationOverlay.classList.add('active');
            calibrationMessage.textContent = 'ç·‘ã®ç‚¹ã‚’è¦‹ã¤ã‚ã¦ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„';
            showCalibrationPoint(currentCalibPoint);
            updateStatus('ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸­...', 'calibrating');
        }
        
        // ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚¤ãƒ³ãƒˆã‚’è¡¨ç¤º
        function showCalibrationPoint(index) {
            if (index >= calibrationPoints.length) {
                finishCalibration();
                return;
            }
            
            const point = calibrationPoints[index];
            calibrationPoint.style.left = point.x + 'px';
            calibrationPoint.style.top = point.y + 'px';
            calibrationPoint.classList.add('active');
            
            collectingSamples = false;
            calibrationSamples = [];
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
            document.querySelectorAll('.calibration-progress .dot').forEach((dot, i) => {
                dot.classList.toggle('complete', i < index);
            });
        }
        
        // ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚¤ãƒ³ãƒˆã‚¯ãƒªãƒƒã‚¯
        calibrationPoint.addEventListener('click', () => {
            if (!collectingSamples) {
                collectingSamples = true;
                calibrationSamples = [];
                calibrationMessage.textContent = 'ãã®ã¾ã¾è¦‹ã¤ã‚ã¦ãã ã•ã„... (ã‚µãƒ³ãƒ—ãƒ«åé›†ä¸­)';
                
                // 1ç§’é–“ã‚µãƒ³ãƒ—ãƒ«åé›†
                setTimeout(() => {
                    if (calibrationSamples.length >= 10) {
                        // ã‚µãƒ³ãƒ—ãƒ«ã®å¹³å‡ã‚’å–å¾—
                        const avgGaze = {
                            x: calibrationSamples.reduce((s, g) => s + g.x, 0) / calibrationSamples.length,
                            y: calibrationSamples.reduce((s, g) => s + g.y, 0) / calibrationSamples.length
                        };
                        
                        screenGazeTracker.addCalibrationPoint(
                            avgGaze, 
                            calibrationPoints[currentCalibPoint]
                        );
                    }
                    
                    currentCalibPoint++;
                    collectingSamples = false;
                    calibrationMessage.textContent = 'ç·‘ã®ç‚¹ã‚’è¦‹ã¤ã‚ã¦ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„';
                    showCalibrationPoint(currentCalibPoint);
                }, 1000);
            }
        });
        
        // ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†
        function finishCalibration() {
            screenGazeTracker.finishCalibration();
            calibrationOverlay.classList.remove('active');
            calibrationPoint.classList.remove('active');
            
            updateStatus('ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†', 'active');
            document.getElementById('btn-toggle-cursor').disabled = false;
            
            // è‡ªå‹•çš„ã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’æœ‰åŠ¹åŒ–
            showCursor = true;
            gazeCursor.style.display = 'block';
            document.getElementById('btn-toggle-cursor').textContent = 'ğŸ‘† ã‚«ãƒ¼ã‚½ãƒ«éè¡¨ç¤º';
        }
        
        // ãƒ•ãƒ¬ãƒ¼ãƒ å‡¦ç†
        function processFrame() {
            if (!isRunning) return;
            
            const ctx = overlay.getContext('2d');
            ctx.clearRect(0, 0, overlay.width, overlay.height);
            
            if (faceLandmarker && video.readyState >= 2) {
                const results = faceLandmarker.detectForVideo(video, performance.now());
                
                if (results.faceLandmarks && results.faceLandmarks.length > 0) {
                    const landmarks = results.faceLandmarks[0];
                    
                    // ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯æç”»ï¼ˆç›®ã®å‘¨ã‚Šï¼‰
                    drawEyeLandmarks(ctx, landmarks);
                    
                    // è¦–ç·šæ›´æ–°
                    const gazeData = screenGazeTracker.update(landmarks);
                    
                    // ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã®ã‚µãƒ³ãƒ—ãƒ«åé›†
                    if (collectingSamples && gazeData.rawGaze) {
                        calibrationSamples.push(gazeData.rawGaze);
                    }
                    
                    // ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ¸ˆã¿ã®å ´åˆ
                    if (screenGazeTracker.isCalibrated && gazeData.screenPosition) {
                        const pos = gazeData.screenPosition;
                        
                        // ã‚«ãƒ¼ã‚½ãƒ«æ›´æ–°
                        if (showCursor) {
                            gazeCursor.style.left = pos.x + 'px';
                            gazeCursor.style.top = pos.y + 'px';
                            gazeCursor.classList.toggle('low-confidence', gazeData.confidence < 0.5);
                        }
                        
                        // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã«ãƒã‚¤ãƒ³ãƒˆè¿½åŠ 
                        gazeHeatmap.addPoint(pos.x, pos.y, gazeData.confidence);
                        
                        // ãƒ‡ãƒ¢ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®åˆ¤å®š
                        checkDemoTargets(pos.x, pos.y);
                        
                        // çµ±è¨ˆæ›´æ–°
                        document.getElementById('stat-confidence').textContent = 
                            (gazeData.confidence * 100).toFixed(0) + '%';
                    }
                }
            }
            
            // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—æç”»
            if (showHeatmap) {
                if (enableDecay) {
                    gazeHeatmap.applyDecay();
                }
                gazeHeatmap.render();
            }
            
            // çµ±è¨ˆæ›´æ–°
            const stats = gazeHeatmap.computeStatistics();
            document.getElementById('stat-points').textContent = stats.totalPoints;
            document.getElementById('stat-coverage').textContent = 
                (stats.coverage * 100).toFixed(1) + '%';
            document.getElementById('stat-avg-x').textContent = 
                stats.avgPosition.x.toFixed(0);
            document.getElementById('stat-avg-y').textContent = 
                stats.avgPosition.y.toFixed(0);
            
            requestAnimationFrame(processFrame);
        }
        
        // ç›®ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯æç”»
        function drawEyeLandmarks(ctx, landmarks) {
            const leftIrisIndices = [468, 469, 470, 471, 472];
            const rightIrisIndices = [473, 474, 475, 476, 477];
            
            ctx.fillStyle = '#00ff88';
            
            [...leftIrisIndices, ...rightIrisIndices].forEach(idx => {
                const point = landmarks[idx];
                ctx.beginPath();
                ctx.arc(point.x * overlay.width, point.y * overlay.height, 2, 0, Math.PI * 2);
                ctx.fill();
            });
        }
        
        // ãƒ‡ãƒ¢ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®è¦–ç·šåˆ¤å®š
        function checkDemoTargets(gazeX, gazeY) {
            document.querySelectorAll('.demo-target').forEach(target => {
                const rect = target.getBoundingClientRect();
                const margin = 40;
                
                const isLooking = gazeX >= rect.left - margin &&
                                 gazeX <= rect.right + margin &&
                                 gazeY >= rect.top - margin &&
                                 gazeY <= rect.bottom + margin;
                
                target.classList.toggle('gazed', isLooking);
            });
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('btn-calibrate').addEventListener('click', startCalibration);
        
        document.getElementById('btn-toggle-cursor').addEventListener('click', () => {
            showCursor = !showCursor;
            gazeCursor.style.display = showCursor ? 'block' : 'none';
            document.getElementById('btn-toggle-cursor').textContent = 
                showCursor ? 'ğŸ‘† ã‚«ãƒ¼ã‚½ãƒ«éè¡¨ç¤º' : 'ğŸ‘† ã‚«ãƒ¼ã‚½ãƒ«è¡¨ç¤º';
        });
        
        document.getElementById('chk-heatmap').addEventListener('change', (e) => {
            showHeatmap = e.target.checked;
            heatmapCanvas.style.display = showHeatmap ? 'block' : 'none';
        });
        
        document.getElementById('chk-decay').addEventListener('change', (e) => {
            enableDecay = e.target.checked;
        });
        
        document.getElementById('btn-clear-heatmap').addEventListener('click', () => {
            gazeHeatmap.clearIntensityMap();
            const ctx = heatmapCanvas.getContext('2d');
            ctx.clearRect(0, 0, heatmapCanvas.width, heatmapCanvas.height);
        });
        
        document.getElementById('btn-export').addEventListener('click', () => {
            const data = gazeHeatmap.exportData();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gaze-data-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });
        
        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
        document.getElementById('slider-smoothing').addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            document.getElementById('smoothing-value').textContent = value;
            if (screenGazeTracker) {
                screenGazeTracker.config.smoothingFactor = value;
            }
        });
        
        document.getElementById('slider-cursor-size').addEventListener('input', (e) => {
            const value = parseInt(e.target.value);
            document.getElementById('cursor-size-value').textContent = value;
            gazeCursor.style.width = value + 'px';
            gazeCursor.style.height = value + 'px';
        });
        
        document.getElementById('slider-heatmap-radius').addEventListener('input', (e) => {
            const value = parseInt(e.target.value);
            document.getElementById('heatmap-radius-value').textContent = value;
            if (gazeHeatmap) {
                gazeHeatmap.config.radius = value;
            }
        });
        
        // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
        window.addEventListener('resize', () => {
            heatmapCanvas.width = window.innerWidth;
            heatmapCanvas.height = window.innerHeight;
            if (screenGazeTracker) {
                screenGazeTracker.config.screenWidth = window.innerWidth;
                screenGazeTracker.config.screenHeight = window.innerHeight;
            }
            if (gazeHeatmap) {
                gazeHeatmap.resize(window.innerWidth, window.innerHeight);
            }
            generateCalibrationPoints();
        });
        
        // é–‹å§‹
        init();
    </script>
</body>
</html>
