<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FACS Advanced Eye Analyzer - é«˜åº¦ãªç›®åˆ†æ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #0a0a15; color: #eee; min-height: 100vh; }
        .container { max-width: 1600px; margin: 0 auto; padding: 15px; }
        
        header { text-align: center; padding: 12px 0; border-bottom: 1px solid #333; margin-bottom: 12px; }
        header h1 { font-size: 1.5rem; color: #00d4ff; }
        header p { color: #888; font-size: 0.8rem; margin-top: 5px; }
        nav { margin-top: 8px; }
        nav a { color: #00d4ff; margin: 0 8px; text-decoration: none; font-size: 0.85rem; }
        nav a:hover { text-decoration: underline; }
        
        .main-content { display: grid; grid-template-columns: 1fr 380px; gap: 12px; }
        @media (max-width: 1200px) { .main-content { grid-template-columns: 1fr; } }
        
        .video-section { display: flex; flex-direction: column; gap: 12px; }
        .video-container { position: relative; background: #000; border-radius: 8px; overflow: hidden; aspect-ratio: 16/9; }
        #videoElement { display: none; }
        #canvasElement { width: 100%; height: 100%; object-fit: contain; display: none; }
        .placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #555; gap: 10px; }
        
        .controls { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .btn { padding: 8px 16px; border: none; border-radius: 5px; font-size: 13px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #00d4ff; color: #000; }
        .btn-secondary { background: #333; color: #fff; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }
        
        .metrics-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        @media (max-width: 800px) { .metrics-grid { grid-template-columns: repeat(2, 1fr); } }
        
        .metric-card { background: #1a1a2e; border-radius: 8px; padding: 12px; text-align: center; }
        .metric-card h3 { font-size: 0.7rem; color: #888; text-transform: uppercase; margin-bottom: 5px; }
        .metric-value { font-size: 1.5rem; font-weight: bold; color: #00ff88; }
        .metric-value.warning { color: #ffaa00; }
        .metric-value.danger { color: #ff4444; }
        .metric-sublabel { font-size: 0.7rem; color: #666; margin-top: 3px; }
        
        .sidebar { display: flex; flex-direction: column; gap: 10px; max-height: calc(100vh - 100px); overflow-y: auto; }
        .panel { background: #1a1a2e; border-radius: 8px; padding: 10px; }
        .panel h2 { font-size: 0.8rem; color: #00d4ff; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 5px; display: flex; align-items: center; gap: 5px; }
        
        /* ç³å­”è¨ˆæ¸¬ãƒ‘ãƒãƒ« */
        .pupil-display { display: flex; gap: 10px; margin-bottom: 10px; }
        .pupil-eye { flex: 1; text-align: center; background: #0d1117; padding: 10px; border-radius: 6px; }
        .pupil-visual { width: 50px; height: 50px; margin: 0 auto 8px; border-radius: 50%; border: 3px solid #333; display: flex; align-items: center; justify-content: center; position: relative; }
        .pupil-inner { border-radius: 50%; background: #000; transition: all 0.2s; }
        .pupil-value { font-size: 1.2rem; font-weight: bold; }
        
        .response-indicator { padding: 8px; border-radius: 5px; text-align: center; margin-top: 8px; font-size: 0.85rem; }
        .response-indicator.dilation { background: #1a4d1a; color: #00ff88; }
        .response-indicator.constriction { background: #4d1a1a; color: #ff6b6b; }
        .response-indicator.stable { background: #1a1a3a; color: #888; }
        
        /* ç¬ãåˆ†æãƒ‘ãƒãƒ« */
        .blink-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .blink-stat { background: #0d1117; padding: 8px; border-radius: 5px; text-align: center; }
        .blink-stat-label { font-size: 0.7rem; color: #666; }
        .blink-stat-value { font-size: 1.1rem; font-weight: bold; color: #00d4ff; }
        
        .anxiety-meter { margin-top: 10px; }
        .anxiety-bar { height: 8px; background: #222; border-radius: 4px; overflow: hidden; }
        .anxiety-fill { height: 100%; transition: width 0.3s, background 0.3s; }
        .anxiety-label { font-size: 0.75rem; color: #888; margin-top: 4px; text-align: center; }
        
        /* ãƒã‚¤ã‚¯ãƒ­ã‚µãƒƒã‚«ãƒ¼ãƒ‰ãƒ‘ãƒãƒ« */
        .attention-compass { position: relative; width: 100px; height: 100px; margin: 10px auto; background: #0d1117; border-radius: 50%; border: 2px solid #333; }
        .attention-arrow { position: absolute; top: 50%; left: 50%; width: 40px; height: 4px; background: linear-gradient(90deg, transparent, #00d4ff); transform-origin: left center; transition: transform 0.3s; }
        .attention-center { position: absolute; width: 10px; height: 10px; background: #fff; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .attention-label { text-align: center; font-size: 0.8rem; margin-top: 8px; }
        
        .inhibition-status { padding: 8px; border-radius: 5px; margin-top: 8px; text-align: center; font-size: 0.8rem; }
        .inhibition-status.active { background: #4d1a1a; color: #ff6b6b; animation: pulse 1s infinite; }
        .inhibition-status.normal { background: #1a1a3a; color: #888; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        /* è¦–ç·šé…åˆ†ãƒ‘ãƒãƒ« */
        .gaze-distribution { margin: 10px 0; }
        .gaze-bar { display: flex; align-items: center; margin-bottom: 6px; font-size: 0.75rem; }
        .gaze-bar-label { width: 50px; color: #888; }
        .gaze-bar-track { flex: 1; height: 12px; background: #222; border-radius: 3px; overflow: hidden; margin: 0 8px; }
        .gaze-bar-fill { height: 100%; transition: width 0.2s; }
        .gaze-bar-fill.eyes { background: #00d4ff; }
        .gaze-bar-fill.nose { background: #ff9f43; }
        .gaze-bar-fill.mouth { background: #ee5a24; }
        .gaze-bar-fill.other { background: #666; }
        .gaze-bar-value { width: 35px; text-align: right; font-family: monospace; }
        
        .emotion-match { background: #0d1117; padding: 10px; border-radius: 5px; margin-top: 10px; text-align: center; }
        .emotion-match-label { font-size: 0.7rem; color: #666; }
        .emotion-match-value { font-size: 1.2rem; font-weight: bold; margin-top: 3px; }
        
        /* æ„Ÿæƒ…çŠ¶æ…‹ãƒ‘ãƒãƒ« */
        .emotion-state { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .emotion-item { background: #0d1117; padding: 10px; border-radius: 5px; text-align: center; }
        .emotion-emoji { font-size: 1.5rem; }
        .emotion-label { font-size: 0.7rem; color: #888; margin-top: 3px; }
        .emotion-confidence { font-size: 0.8rem; color: #00ff88; }
        
        /* èªçŸ¥è² è·ãƒ‘ãƒãƒ« */
        .cognitive-load { display: flex; align-items: center; gap: 10px; padding: 10px; background: #0d1117; border-radius: 5px; }
        .load-icon { font-size: 1.5rem; }
        .load-details { flex: 1; }
        .load-level { font-weight: bold; }
        .load-description { font-size: 0.75rem; color: #888; margin-top: 2px; }
        
        /* AUä¸€è¦§ */
        .au-list { max-height: 150px; overflow-y: auto; }
        .au-item { display: flex; align-items: center; padding: 4px 6px; margin-bottom: 3px; background: #0d1117; border-radius: 3px; font-size: 0.75rem; }
        .au-code { font-family: monospace; font-weight: bold; color: #00d4ff; width: 40px; }
        .au-name { flex: 1; color: #888; }
        .au-bar { width: 50px; height: 4px; background: #222; border-radius: 2px; margin: 0 5px; overflow: hidden; }
        .au-bar-fill { height: 100%; background: linear-gradient(90deg, #00d4ff, #00ff88); }
        .au-value { width: 30px; text-align: right; font-family: monospace; }
        
        /* ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ */
        .calibration-progress { margin-top: 8px; }
        .calibration-bar { height: 4px; background: #333; border-radius: 2px; overflow: hidden; }
        .calibration-fill { height: 100%; background: #ffaa00; transition: width 0.3s; }
        .calibration-text { font-size: 0.7rem; color: #888; text-align: center; margin-top: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ‘ï¸ Advanced Eye Analyzer</h1>
            <p>ç³å­”è¨ˆæ¸¬ãƒ»ç¬ãåˆ†æãƒ»ãƒã‚¤ã‚¯ãƒ­ã‚µãƒƒã‚«ãƒ¼ãƒ‰ãƒ»è¦–ç·šé…åˆ†</p>
            <nav>
                <a href="index.html">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ†æ</a>
                <a href="emotion-recorder.html">æ„Ÿæƒ…è¨˜éŒ²</a>
                <a href="eye-focus.html">åŸºæœ¬ç›®åˆ†æ</a>
                <a href="advanced-eye.html">é«˜åº¦ãªç›®åˆ†æ</a>
                <a href="screen-gaze.html">ğŸ¯ è¦–ç·šã‚«ãƒ¼ã‚½ãƒ«</a>
            </nav>
        </header>
        
        <div class="main-content">
            <div class="video-section">
                <div class="video-container">
                    <video id="videoElement" playsinline></video>
                    <canvas id="canvasElement"></canvas>
                    <div id="placeholder" class="placeholder">
                        <span style="font-size: 3rem;">ğŸ‘ï¸â€ğŸ—¨ï¸</span>
                        <span>ã€Œé–‹å§‹ã€ãƒœã‚¿ãƒ³ã§ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•</span>
                        <span style="font-size: 0.8rem; color: #666;">ç³å­”ãƒ»ç¬ããƒ»è¦–ç·šã®é«˜åº¦ãªåˆ†æ</span>
                    </div>
                </div>
                
                <div class="metrics-grid">
                    <div class="metric-card">
                        <h3>ç³å­”åå¿œ</h3>
                        <div id="pupilResponse" class="metric-value">---</div>
                        <div id="pupilLabel" class="metric-sublabel">å¾…æ©Ÿä¸­</div>
                    </div>
                    <div class="metric-card">
                        <h3>ç¬ç›®ç‡</h3>
                        <div id="blinkRate" class="metric-value">---</div>
                        <div id="blinkLabel" class="metric-sublabel">å›/åˆ†</div>
                    </div>
                    <div class="metric-card">
                        <h3>ä¸å®‰æŒ‡æ¨™</h3>
                        <div id="anxietyLevel" class="metric-value">---</div>
                        <div id="anxietyLabel" class="metric-sublabel">å¾…æ©Ÿä¸­</div>
                    </div>
                    <div class="metric-card">
                        <h3>èªçŸ¥è² è·</h3>
                        <div id="cognitiveLoad" class="metric-value">---</div>
                        <div id="loadLabel" class="metric-sublabel">å¾…æ©Ÿä¸­</div>
                    </div>
                </div>
                
                <div class="controls">
                    <button id="startBtn" class="btn btn-primary">â–¶ é–‹å§‹</button>
                    <button id="stopBtn" class="btn btn-secondary" disabled>â–  åœæ­¢</button>
                    <button id="recalibBtn" class="btn btn-secondary" disabled>ğŸ”„ å†ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</button>
                </div>
            </div>
            
            <div class="sidebar">
                <!-- ç³å­”è¨ˆæ¸¬ãƒ‘ãƒãƒ« -->
                <div class="panel">
                    <h2>ğŸ‘ï¸ ç³å­”è¨ˆæ¸¬ï¼ˆPupillometryï¼‰</h2>
                    <div class="pupil-display">
                        <div class="pupil-eye">
                            <div class="pupil-visual">
                                <div id="leftPupil" class="pupil-inner" style="width: 20px; height: 20px;"></div>
                            </div>
                            <div class="pupil-value" id="leftPupilValue">--</div>
                            <div style="font-size: 0.7rem; color: #666;">å·¦ç›®</div>
                        </div>
                        <div class="pupil-eye">
                            <div class="pupil-visual">
                                <div id="rightPupil" class="pupil-inner" style="width: 20px; height: 20px;"></div>
                            </div>
                            <div class="pupil-value" id="rightPupilValue">--</div>
                            <div style="font-size: 0.7rem; color: #666;">å³ç›®</div>
                        </div>
                    </div>
                    <div id="pupilResponseIndicator" class="response-indicator stable">
                        å®‰å®š
                    </div>
                    <div id="emotionalValence" style="text-align: center; margin-top: 8px; font-size: 0.8rem; color: #888;">
                        æ„Ÿæƒ…ä¾¡: ---
                    </div>
                </div>
                
                <!-- ç¬ãåˆ†æãƒ‘ãƒãƒ« -->
                <div class="panel">
                    <h2>ğŸ‘€ ç¬ãåˆ†æ</h2>
                    <div class="blink-stats">
                        <div class="blink-stat">
                            <div class="blink-stat-label">ç¬ç›®ç‡</div>
                            <div class="blink-stat-value" id="blinkRateValue">--</div>
                            <div style="font-size: 0.65rem; color: #666;">å›/åˆ†</div>
                        </div>
                        <div class="blink-stat">
                            <div class="blink-stat-label">æŒ¯å¹…</div>
                            <div class="blink-stat-value" id="blinkAmplitude">--</div>
                            <div style="font-size: 0.65rem; color: #666;">æ·±ã•</div>
                        </div>
                    </div>
                    <div class="anxiety-meter">
                        <div style="font-size: 0.75rem; color: #888; margin-bottom: 4px;">ä¸å®‰æŒ‡æ¨™</div>
                        <div class="anxiety-bar">
                            <div id="anxietyBar" class="anxiety-fill" style="width: 0%; background: #00ff88;"></div>
                        </div>
                        <div id="anxietyDescription" class="anxiety-label">ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸­...</div>
                    </div>
                </div>
                
                <!-- ãƒã‚¤ã‚¯ãƒ­ã‚µãƒƒã‚«ãƒ¼ãƒ‰ãƒ‘ãƒãƒ« -->
                <div class="panel">
                    <h2>ğŸ¯ æ½œåœ¨çš„æ³¨æ„ï¼ˆãƒã‚¤ã‚¯ãƒ­ã‚µãƒƒã‚«ãƒ¼ãƒ‰ï¼‰</h2>
                    <div class="attention-compass">
                        <div id="attentionArrow" class="attention-arrow" style="transform: rotate(0deg);"></div>
                        <div class="attention-center"></div>
                    </div>
                    <div id="attentionLabel" class="attention-label">åˆ†æä¸­...</div>
                    <div id="inhibitionStatus" class="inhibition-status normal">
                        é€šå¸¸çŠ¶æ…‹
                    </div>
                </div>
                
                <!-- è¦–ç·šé…åˆ†ãƒ‘ãƒãƒ« -->
                <div class="panel">
                    <h2>ğŸ“ è¦–ç·šé…åˆ†ï¼ˆGaze Allocationï¼‰</h2>
                    <div class="gaze-distribution">
                        <div class="gaze-bar">
                            <span class="gaze-bar-label">ç›®</span>
                            <div class="gaze-bar-track"><div id="gazeEyes" class="gaze-bar-fill eyes" style="width: 0%"></div></div>
                            <span id="gazeEyesValue" class="gaze-bar-value">--%</span>
                        </div>
                        <div class="gaze-bar">
                            <span class="gaze-bar-label">é¼»</span>
                            <div class="gaze-bar-track"><div id="gazeNose" class="gaze-bar-fill nose" style="width: 0%"></div></div>
                            <span id="gazeNoseValue" class="gaze-bar-value">--%</span>
                        </div>
                        <div class="gaze-bar">
                            <span class="gaze-bar-label">å£</span>
                            <div class="gaze-bar-track"><div id="gazeMouth" class="gaze-bar-fill mouth" style="width: 0%"></div></div>
                            <span id="gazeMouthValue" class="gaze-bar-value">--%</span>
                        </div>
                    </div>
                    <div class="emotion-match">
                        <div class="emotion-match-label">è¦–ç·šãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰æ¨å®š</div>
                        <div id="gazeEmotionMatch" class="emotion-match-value">---</div>
                    </div>
                </div>
                
                <!-- çµ±åˆæ„Ÿæƒ…çŠ¶æ…‹ãƒ‘ãƒãƒ« -->
                <div class="panel">
                    <h2>ğŸ­ çµ±åˆæ„Ÿæƒ…æ¨å®š</h2>
                    <div class="emotion-state">
                        <div class="emotion-item">
                            <div id="primaryEmotionEmoji" class="emotion-emoji">ğŸ˜</div>
                            <div class="emotion-label">ä¸»è¦æ„Ÿæƒ…</div>
                            <div id="primaryEmotion" class="emotion-confidence">neutral</div>
                        </div>
                        <div class="emotion-item">
                            <div id="arousalEmoji" class="emotion-emoji">ğŸ˜´</div>
                            <div class="emotion-label">è¦šé†’åº¦</div>
                            <div id="arousalLevel" class="emotion-confidence">ä½</div>
                        </div>
                    </div>
                    <div class="cognitive-load" style="margin-top: 10px;">
                        <div id="loadIcon" class="load-icon">ğŸ§ </div>
                        <div class="load-details">
                            <div id="loadLevelText" class="load-level">èªçŸ¥è² è·: ---</div>
                            <div id="loadDescription" class="load-description">ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸­...</div>
                        </div>
                    </div>
                </div>
                
                <!-- ç›®é–¢é€£AU -->
                <div class="panel">
                    <h2>ğŸ“Š ç›®é–¢é€£Action Units</h2>
                    <div id="auList" class="au-list">
                        <div style="color: #666; text-align: center; padding: 15px;">æ¤œå‡ºå¾…æ©Ÿä¸­</div>
                    </div>
                </div>
                
                <!-- ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ -->
                <div class="panel">
                    <h2>âš™ï¸ ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h2>
                    <div class="calibration-progress">
                        <div class="calibration-bar">
                            <div id="calibrationFill" class="calibration-fill" style="width: 0%"></div>
                        </div>
                        <div id="calibrationText" class="calibration-text">æ™®é€šã«ç”»é¢ã‚’è¦‹ã¦ãã ã•ã„...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="js/mediapipe-face.js"></script>
    <script src="js/eye-analyzer.js"></script>
    <script src="js/pupillometry.js"></script>
    <script src="js/blink-analyzer.js"></script>
    <script src="js/microsaccade-detector.js"></script>
    <script src="js/gaze-allocation.js"></script>
    
    <script>
        // DOMè¦ç´ 
        const elements = {
            video: document.getElementById('videoElement'),
            canvas: document.getElementById('canvasElement'),
            placeholder: document.getElementById('placeholder'),
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            recalibBtn: document.getElementById('recalibBtn'),
            
            // ãƒ¡ãƒˆãƒªã‚¯ã‚¹
            pupilResponse: document.getElementById('pupilResponse'),
            pupilLabel: document.getElementById('pupilLabel'),
            blinkRate: document.getElementById('blinkRate'),
            blinkLabel: document.getElementById('blinkLabel'),
            anxietyLevel: document.getElementById('anxietyLevel'),
            anxietyLabel: document.getElementById('anxietyLabel'),
            cognitiveLoad: document.getElementById('cognitiveLoad'),
            loadLabel: document.getElementById('loadLabel'),
            
            // ç³å­”ãƒ‘ãƒãƒ«
            leftPupil: document.getElementById('leftPupil'),
            rightPupil: document.getElementById('rightPupil'),
            leftPupilValue: document.getElementById('leftPupilValue'),
            rightPupilValue: document.getElementById('rightPupilValue'),
            pupilResponseIndicator: document.getElementById('pupilResponseIndicator'),
            emotionalValence: document.getElementById('emotionalValence'),
            
            // ç¬ããƒ‘ãƒãƒ«
            blinkRateValue: document.getElementById('blinkRateValue'),
            blinkAmplitude: document.getElementById('blinkAmplitude'),
            anxietyBar: document.getElementById('anxietyBar'),
            anxietyDescription: document.getElementById('anxietyDescription'),
            
            // ãƒã‚¤ã‚¯ãƒ­ã‚µãƒƒã‚«ãƒ¼ãƒ‰ãƒ‘ãƒãƒ«
            attentionArrow: document.getElementById('attentionArrow'),
            attentionLabel: document.getElementById('attentionLabel'),
            inhibitionStatus: document.getElementById('inhibitionStatus'),
            
            // è¦–ç·šé…åˆ†ãƒ‘ãƒãƒ«
            gazeEyes: document.getElementById('gazeEyes'),
            gazeNose: document.getElementById('gazeNose'),
            gazeMouth: document.getElementById('gazeMouth'),
            gazeEyesValue: document.getElementById('gazeEyesValue'),
            gazeNoseValue: document.getElementById('gazeNoseValue'),
            gazeMouthValue: document.getElementById('gazeMouthValue'),
            gazeEmotionMatch: document.getElementById('gazeEmotionMatch'),
            
            // æ„Ÿæƒ…çŠ¶æ…‹ãƒ‘ãƒãƒ«
            primaryEmotionEmoji: document.getElementById('primaryEmotionEmoji'),
            primaryEmotion: document.getElementById('primaryEmotion'),
            arousalEmoji: document.getElementById('arousalEmoji'),
            arousalLevel: document.getElementById('arousalLevel'),
            loadIcon: document.getElementById('loadIcon'),
            loadLevelText: document.getElementById('loadLevelText'),
            loadDescription: document.getElementById('loadDescription'),
            
            // AUä¸€è¦§
            auList: document.getElementById('auList'),
            
            // ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            calibrationFill: document.getElementById('calibrationFill'),
            calibrationText: document.getElementById('calibrationText')
        };
        
        // åˆ†æãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
        let detector = null;
        let eyeAnalyzer = null;
        let pupillometry = null;
        let blinkAnalyzer = null;
        let microsaccadeDetector = null;
        let gazeAllocation = null;
        
        let isRunning = false;
        let animationId = null;
        
        // æ„Ÿæƒ…çµµæ–‡å­—ãƒãƒƒãƒ—
        const emotionEmojis = {
            happy: 'ğŸ˜Š', sad: 'ğŸ˜¢', angry: 'ğŸ˜ ', surprise: 'ğŸ˜²',
            fear: 'ğŸ˜¨', disgust: 'ğŸ¤¢', contempt: 'ğŸ˜', neutral: 'ğŸ˜',
            interest: 'ğŸ¤”', unknown: 'â“'
        };
        
        // AUåç§°
        const auNames = {
            'AU1': 'çœ‰å†…å´æŒ™ä¸Š', 'AU2': 'çœ‰å¤–å´æŒ™ä¸Š', 'AU4': 'çœ‰ä¸‹åˆ¶',
            'AU5': 'ä¸Šç¼æŒ™ä¸Š', 'AU6': 'é ¬æŒ™ä¸Š', 'AU7': 'ç¼ç·Šå¼µ',
            'AU43': 'ç›®é–‰ã˜', 'AU45': 'ç¬ã',
            'AU61': 'è¦–ç·šä¸Š', 'AU62': 'è¦–ç·šä¸‹', 'AU63': 'è¦–ç·šå·¦', 'AU64': 'è¦–ç·šå³'
        };
        
        // é–‹å§‹ãƒœã‚¿ãƒ³
        elements.startBtn.addEventListener('click', async () => {
            try {
                elements.startBtn.disabled = true;
                
                // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆæœŸåŒ–
                detector = new MediaPipeFaceDetector();
                await detector.initialize();
                
                eyeAnalyzer = new EyeAnalyzer();
                pupillometry = new Pupillometry();
                blinkAnalyzer = new BlinkAnalyzer();
                microsaccadeDetector = new MicrosaccadeDetector();
                gazeAllocation = new GazeAllocationAnalyzer();
                
                // ã‚«ãƒ¡ãƒ©èµ·å‹•
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: 'user' }
                });
                
                elements.video.srcObject = stream;
                await elements.video.play();
                
                elements.canvas.width = elements.video.videoWidth;
                elements.canvas.height = elements.video.videoHeight;
                
                elements.placeholder.style.display = 'none';
                elements.canvas.style.display = 'block';
                elements.stopBtn.disabled = false;
                elements.recalibBtn.disabled = false;
                
                isRunning = true;
                processFrame();
                
            } catch (error) {
                console.error(error);
                elements.startBtn.disabled = false;
                alert('ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        });
        
        // åœæ­¢ãƒœã‚¿ãƒ³
        elements.stopBtn.addEventListener('click', () => {
            stopAnalysis();
        });
        
        // å†ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
        elements.recalibBtn.addEventListener('click', () => {
            if (eyeAnalyzer) eyeAnalyzer.resetCalibration();
            if (pupillometry) pupillometry.reset();
            if (blinkAnalyzer) blinkAnalyzer.reset();
            if (microsaccadeDetector) microsaccadeDetector.reset();
            if (gazeAllocation) gazeAllocation.reset();
            
            elements.calibrationText.textContent = 'å†ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸­...';
            elements.calibrationFill.style.width = '0%';
            elements.calibrationFill.style.background = '#ffaa00';
        });
        
        function stopAnalysis() {
            isRunning = false;
            if (animationId) cancelAnimationFrame(animationId);
            if (elements.video.srcObject) {
                elements.video.srcObject.getTracks().forEach(t => t.stop());
            }
            if (detector) detector.close();
            
            elements.placeholder.style.display = 'flex';
            elements.canvas.style.display = 'none';
            elements.startBtn.disabled = false;
            elements.stopBtn.disabled = true;
            elements.recalibBtn.disabled = true;
        }
        
        // ãƒ•ãƒ¬ãƒ¼ãƒ å‡¦ç†
        async function processFrame() {
            if (!isRunning) return;
            
            const ctx = elements.canvas.getContext('2d');
            ctx.drawImage(elements.video, 0, 0);
            const timestamp = performance.now();
            
            try {
                const results = detector.detect(elements.video);
                
                if (results.faceLandmarks.length > 0) {
                    const landmarks = results.faceLandmarks[0];
                    const blendshapes = results.faceBlendshapes[0] || {};
                    
                    // ç›®ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‚’æç”»
                    drawEyeLandmarks(ctx, landmarks);
                    
                    // åŸºæœ¬çš„ãªç›®åˆ†æ
                    const eyeResult = eyeAnalyzer.analyze(landmarks, blendshapes);
                    
                    if (eyeResult) {
                        // ç³å­”è¨ˆæ¸¬
                        const pupilData = extractPupilData(landmarks, eyeResult);
                        const pupilResult = pupillometry.update(pupilData, timestamp);
                        
                        // ç¬ãåˆ†æ
                        const avgOpenness = (eyeResult.leftEye.normalizedOpenness + eyeResult.rightEye.normalizedOpenness) / 2;
                        const blinkResult = blinkAnalyzer.update(avgOpenness, timestamp);
                        
                        // ãƒã‚¤ã‚¯ãƒ­ã‚µãƒƒã‚«ãƒ¼ãƒ‰æ¤œå‡º
                        const gazePos = {
                            x: (eyeResult.gaze.horizontal + 0.5),
                            y: (eyeResult.gaze.vertical + 0.5)
                        };
                        const microsaccadeResult = microsaccadeDetector.update(gazePos, timestamp);
                        
                        // è¦–ç·šé…åˆ†åˆ†æ
                        gazeAllocation.updateAOIsFromLandmarks(landmarks);
                        const gazeResult = gazeAllocation.update(gazePos, timestamp);
                        
                        // UIæ›´æ–°
                        updateUI({
                            eye: eyeResult,
                            pupil: pupilResult,
                            blink: blinkResult,
                            microsaccade: microsaccadeResult,
                            gaze: gazeResult
                        });
                    }
                }
            } catch (error) {
                console.error('Frame error:', error);
            }
            
            animationId = requestAnimationFrame(processFrame);
        }
        
        // ç³å­”ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
        function extractPupilData(landmarks, eyeResult) {
            // è™¹å½©ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‹ã‚‰ç³å­”ãƒ‡ãƒ¼ã‚¿ã‚’æ¨å®š
            const leftIris = landmarks[468]; // å·¦ç›®è™¹å½©ä¸­å¿ƒ
            const rightIris = landmarks[473]; // å³ç›®è™¹å½©ä¸­å¿ƒ
            
            // è™¹å½©ã®ç›´å¾„ã‚’è¨ˆç®—ï¼ˆæ¦‚ç®—ï¼‰
            const leftDiameter = eyeResult.leftEye.height * 0.7;
            const rightDiameter = eyeResult.rightEye.height * 0.7;
            
            return {
                left: {
                    diameter: leftDiameter,
                    center: { x: leftIris.x, y: leftIris.y }
                },
                right: {
                    diameter: rightDiameter,
                    center: { x: rightIris.x, y: rightIris.y }
                }
            };
        }
        
        // ç›®ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‚’æç”»
        function drawEyeLandmarks(ctx, landmarks) {
            ctx.fillStyle = '#00ff88';
            ctx.strokeStyle = '#00d4ff';
            ctx.lineWidth = 2;
            
            // å·¦ç›®ã®è¼ªéƒ­
            const leftIndices = [362, 382, 381, 380, 374, 373, 390, 249, 263, 466, 388, 387, 386, 385, 384, 398];
            drawEyeContour(ctx, landmarks, leftIndices);
            
            // å³ç›®ã®è¼ªéƒ­
            const rightIndices = [33, 7, 163, 144, 145, 153, 154, 155, 133, 173, 157, 158, 159, 160, 161, 246];
            drawEyeContour(ctx, landmarks, rightIndices);
            
            // è™¹å½©/ç³å­”
            const leftIris = landmarks[468];
            const rightIris = landmarks[473];
            
            ctx.fillStyle = '#00d4ff';
            [leftIris, rightIris].forEach(iris => {
                ctx.beginPath();
                ctx.arc(iris.x * elements.canvas.width, iris.y * elements.canvas.height, 6, 0, Math.PI * 2);
                ctx.fill();
            });
        }
        
        function drawEyeContour(ctx, landmarks, indices) {
            ctx.beginPath();
            indices.forEach((idx, i) => {
                const p = landmarks[idx];
                const x = p.x * elements.canvas.width;
                const y = p.y * elements.canvas.height;
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            });
            ctx.closePath();
            ctx.stroke();
        }
        
        // UIæ›´æ–°
        function updateUI(results) {
            const { eye, pupil, blink, microsaccade, gaze } = results;
            
            // === ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚«ãƒ¼ãƒ‰ ===
            
            // ç³å­”åå¿œ
            if (pupil) {
                const responseType = pupil.response?.type || 'stable';
                elements.pupilResponse.textContent = pupil.response?.label || '---';
                elements.pupilResponse.className = 'metric-value' + 
                    (responseType === 'dilation' ? '' : responseType === 'constriction' ? ' danger' : '');
                elements.pupilLabel.textContent = pupil.response?.description?.substring(0, 20) || 'å¾…æ©Ÿä¸­';
            }
            
            // ç¬ç›®ç‡
            if (blink) {
                elements.blinkRate.textContent = blink.statistics?.rate || '--';
                elements.blinkRate.className = 'metric-value' + 
                    (blink.statistics?.rate > 25 ? ' warning' : blink.statistics?.rate < 10 ? ' warning' : '');
                elements.blinkLabel.textContent = blink.statistics?.rateLabel || 'å›/åˆ†';
            }
            
            // ä¸å®‰æŒ‡æ¨™
            if (blink?.psychological?.anxiety) {
                const anxiety = blink.psychological.anxiety;
                elements.anxietyLevel.textContent = anxiety.level;
                elements.anxietyLevel.className = 'metric-value' + 
                    (anxiety.level === 'high' ? ' danger' : anxiety.level === 'moderate' ? ' warning' : '');
                elements.anxietyLabel.textContent = 'ç¬ãåˆ†æã‹ã‚‰æ¨å®š';
            }
            
            // èªçŸ¥è² è·
            if (pupil?.cognitiveLoad) {
                const load = pupil.cognitiveLoad;
                elements.cognitiveLoad.textContent = load.level;
                elements.cognitiveLoad.className = 'metric-value' + 
                    (load.level === 'high' ? ' warning' : '');
                elements.loadLabel.textContent = 'ç³å­”åå¿œã‹ã‚‰æ¨å®š';
            }
            
            // === ç³å­”ãƒ‘ãƒãƒ« ===
            if (pupil) {
                // ç³å­”ã‚µã‚¤ã‚ºã®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«
                const leftSize = 15 + (pupil.diameter?.left || 0) * 100;
                const rightSize = 15 + (pupil.diameter?.right || 0) * 100;
                elements.leftPupil.style.width = `${Math.min(35, leftSize)}px`;
                elements.leftPupil.style.height = `${Math.min(35, leftSize)}px`;
                elements.rightPupil.style.width = `${Math.min(35, rightSize)}px`;
                elements.rightPupil.style.height = `${Math.min(35, rightSize)}px`;
                
                elements.leftPupilValue.textContent = ((pupil.diameter?.left || 0) * 100).toFixed(1);
                elements.rightPupilValue.textContent = ((pupil.diameter?.right || 0) * 100).toFixed(1);
                
                // åå¿œã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿
                const responseClass = pupil.response?.type || 'stable';
                elements.pupilResponseIndicator.className = `response-indicator ${responseClass}`;
                elements.pupilResponseIndicator.textContent = pupil.response?.description || 'å®‰å®š';
                
                // æ„Ÿæƒ…ä¾¡
                if (pupil.emotional) {
                    const valence = pupil.emotional.valence;
                    elements.emotionalValence.textContent = 
                        `æ„Ÿæƒ…ä¾¡: ${valence > 0 ? '+' : ''}${valence.toFixed(2)} (${pupil.emotional.dominantEmotion || 'neutral'})`;
                }
            }
            
            // === ç¬ããƒ‘ãƒãƒ« ===
            if (blink) {
                elements.blinkRateValue.textContent = blink.statistics?.rate || '--';
                elements.blinkAmplitude.textContent = 
                    blink.statistics?.avgAmplitude ? (blink.statistics.avgAmplitude * 100).toFixed(0) + '%' : '--';
                
                // ä¸å®‰ãƒãƒ¼
                const anxietyValue = blink.psychological?.anxiety?.value || 0;
                elements.anxietyBar.style.width = `${anxietyValue * 100}%`;
                elements.anxietyBar.style.background = anxietyValue > 0.5 ? '#ff4444' : anxietyValue > 0.25 ? '#ffaa00' : '#00ff88';
                elements.anxietyDescription.textContent = 
                    blink.psychological?.anxiety?.level === 'high' ? 'é«˜ã„ä¸å®‰çŠ¶æ…‹ã®å¯èƒ½æ€§' :
                    blink.psychological?.anxiety?.level === 'moderate' ? 'ä¸­ç¨‹åº¦ã®ç·Šå¼µ' : 'æ­£å¸¸';
            }
            
            // === ãƒã‚¤ã‚¯ãƒ­ã‚µãƒƒã‚«ãƒ¼ãƒ‰ãƒ‘ãƒãƒ« ===
            if (microsaccade) {
                // æ³¨æ„æ–¹å‘ã®çŸ¢å°
                if (microsaccade.attention?.bias?.direction !== undefined) {
                    const degrees = (microsaccade.attention.bias.direction * 180 / Math.PI);
                    elements.attentionArrow.style.transform = `rotate(${degrees}deg)`;
                    elements.attentionArrow.style.opacity = microsaccade.attention.bias.isSignificant ? '1' : '0.3';
                }
                
                elements.attentionLabel.textContent = 
                    microsaccade.attention?.interpretation || 'åˆ†æä¸­...';
                
                // æŠ‘åˆ¶çŠ¶æ…‹
                if (microsaccade.inhibition?.isInhibited) {
                    elements.inhibitionStatus.className = 'inhibition-status active';
                    elements.inhibitionStatus.textContent = microsaccade.inhibition.interpretation;
                } else {
                    elements.inhibitionStatus.className = 'inhibition-status normal';
                    elements.inhibitionStatus.textContent = 'é€šå¸¸çŠ¶æ…‹';
                }
            }
            
            // === è¦–ç·šé…åˆ†ãƒ‘ãƒãƒ« ===
            if (gaze) {
                const dist = gaze.distribution?.summary || {};
                
                const eyesPercent = (dist.eyes || 0) * 100;
                const nosePercent = (dist.nose || 0) * 100;
                const mouthPercent = (dist.mouth || 0) * 100;
                
                elements.gazeEyes.style.width = `${eyesPercent}%`;
                elements.gazeNose.style.width = `${nosePercent}%`;
                elements.gazeMouth.style.width = `${mouthPercent}%`;
                
                elements.gazeEyesValue.textContent = `${eyesPercent.toFixed(0)}%`;
                elements.gazeNoseValue.textContent = `${nosePercent.toFixed(0)}%`;
                elements.gazeMouthValue.textContent = `${mouthPercent.toFixed(0)}%`;
                
                // æ„Ÿæƒ…ãƒãƒƒãƒãƒ³ã‚°
                if (gaze.emotionMatch) {
                    elements.gazeEmotionMatch.textContent = 
                        `${emotionEmojis[gaze.emotionMatch.emotion] || 'â“'} ${gaze.emotionMatch.emotion} (${(gaze.emotionMatch.confidence * 100).toFixed(0)}%)`;
                }
            }
            
            // === çµ±åˆæ„Ÿæƒ…ãƒ‘ãƒãƒ« ===
            const primaryEmotion = pupil?.emotional?.dominantEmotion || 
                                  gaze?.emotionMatch?.emotion || 'neutral';
            elements.primaryEmotionEmoji.textContent = emotionEmojis[primaryEmotion] || 'ğŸ˜';
            elements.primaryEmotion.textContent = primaryEmotion;
            
            const arousal = pupil?.emotional?.arousal || 0;
            elements.arousalEmoji.textContent = arousal > 0.6 ? 'ğŸ˜³' : arousal > 0.3 ? 'ğŸ™‚' : 'ğŸ˜´';
            elements.arousalLevel.textContent = arousal > 0.6 ? 'é«˜' : arousal > 0.3 ? 'ä¸­' : 'ä½';
            
            if (pupil?.cognitiveLoad) {
                elements.loadIcon.textContent = 
                    pupil.cognitiveLoad.level === 'high' ? 'ğŸ§ ' : 
                    pupil.cognitiveLoad.level === 'medium' ? 'ğŸ’­' : 'ğŸ˜Œ';
                elements.loadLevelText.textContent = `èªçŸ¥è² è·: ${pupil.cognitiveLoad.level}`;
                elements.loadDescription.textContent = pupil.cognitiveLoad.description;
            }
            
            // === AUä¸€è¦§ ===
            if (eye?.actionUnits) {
                const aus = eye.actionUnits;
                const sorted = Object.entries(aus)
                    .filter(([, v]) => v > 0.1)
                    .sort((a, b) => b[1] - a[1]);
                
                if (sorted.length > 0) {
                    elements.auList.innerHTML = sorted.map(([code, value]) => `
                        <div class="au-item">
                            <span class="au-code">${code}</span>
                            <span class="au-name">${auNames[code] || ''}</span>
                            <div class="au-bar"><div class="au-bar-fill" style="width:${value*100}%"></div></div>
                            <span class="au-value">${(value*100).toFixed(0)}%</span>
                        </div>
                    `).join('');
                } else {
                    elements.auList.innerHTML = '<div style="color: #666; text-align: center; padding: 15px;">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªAUãªã—</div>';
                }
            }
            
            // === ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ===
            const calibProgress = Math.min(
                (pupil?.calibration?.progress || 0),
                (blink?.calibration?.isCalibrated ? 1 : 0.5),
                (eye?.calibration?.progress || 0)
            );
            
            elements.calibrationFill.style.width = `${calibProgress * 100}%`;
            
            if (calibProgress >= 1) {
                elements.calibrationFill.style.background = '#00ff88';
                elements.calibrationText.textContent = 'ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†';
            } else {
                elements.calibrationFill.style.background = '#ffaa00';
                elements.calibrationText.textContent = `ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸­... ${(calibProgress * 100).toFixed(0)}%`;
            }
        }
    </script>
</body>
</html>
